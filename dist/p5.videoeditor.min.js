!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("gif.js/src/GIF")):"function"==typeof define&&define.amd?define(["exports","gif.js/src/GIF"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).p5=t.p5||{},t.p5.VideoEditor={}),t.GIF)}(this,function(t,e){"use strict";var i="undefined"!=typeof document?document.currentScript:null;class s{constructor(){this.plugins=[]}register(t){t?"string"==typeof t.name&&""!==t.name.trim()?"string"==typeof t.type&&""!==t.type.trim()?"function"==typeof t.onLoad?this.plugins.some(e=>e.name===t.name)?console.warn(`Plugin with name "${t.name}" is already registered.`):this.plugins.push(t):console.warn('Invalid plugin: "onLoad" must be a function.',t):console.warn('Invalid plugin: "type" must be a non-empty string.',t):console.warn('Invalid plugin: "name" must be a non-empty string.',t):console.warn("Invalid plugin: Plugin object is null or undefined.")}}class r{constructor(t,e){this.p=t,this.canvas=e,this.width=e.width,this.height=e.height,this.sceneBuffer=t.createGraphics(this.width,this.height,t.WEBGL),this.effectBuffer=t.createGraphics(this.width,this.height,t.WEBGL),this.shaders={},this.shaderPromises={},this.postProcessingEffects=[]}loadShader(t,e){if(this.shaders[t]||this.shaderPromises[t])return;const i=this.p.loadShader("src/shaders/passthrough.vert",e,e=>{this.shaders[t]=e,delete this.shaderPromises[t],console.log(`Shader "${t}" loaded.`)});this.shaderPromises[t]=i}async render(t,e,i){this._renderScene(t,e,i);const s=await this._applyPostProcessing();this.p.image(s,0,0),this.postProcessingEffects=[]}_renderScene(t,e,i){this.sceneBuffer.clear(),this.sceneBuffer.push();const s=new Set;for(const t of e)s.add(t.fromClip),s.add(t.toClip);const r=[...t].filter(t=>!s.has(t));r.sort((t,e)=>t.layer-e.layer);for(const t of r){const e=i-t.start;for(const i of t.effects)i.apply(t,this,e);t.render(this.sceneBuffer)}for(const t of e)t.render(this.sceneBuffer,i);this.sceneBuffer.pop()}async _applyPostProcessing(){if(0===this.postProcessingEffects.length)return this.sceneBuffer;let t=this.sceneBuffer,e=this.effectBuffer;for(let i=0;i<this.postProcessingEffects.length;i++){const s=this.postProcessingEffects[i];this.shaderPromises[s.type]&&await this.shaderPromises[s.type];const r=this.shaders[s.type];if(r){if(e.shader(r),r.setUniform("u_texture",t),s.uniforms)for(const[t,e]of Object.entries(s.uniforms))r.setUniform(t,e);e.rect(-this.width/2,-this.height/2,this.width,this.height),[t,e]=[e,t]}}return t}}class o{static critical(t,e){throw console.error(`[p5.videoeditor.js] Critical Error: ${t}`),e&&console.error("Original Error:",e),new Error(`[p5.videoeditor.js] ${t}`)}static warning(t){console.warn(`[p5.videoeditor.js] Warning: ${t}`)}static showUserFriendlyError(t){console.error(`[p5.videoeditor.js] An error occurred: ${t.message}`)}}class n{constructor({start:t=0,duration:e=1e3}={}){this.start=t,this.duration=e}apply(t,e,i){throw new Error('The "apply()" method must be implemented by a subclass.')}}class a extends n{constructor(t={}){super(t),t.type&&t.fragUrl||o.critical("GPUEffectBase requires a `type` and `fragUrl` in its options."),this.type=t.type,this.fragUrl=t.fragUrl,this.uniforms=t.uniforms||{}}apply(t,e,i){i>=this.start&&i<this.start+this.duration&&(e.loadShader(this.type,this.fragUrl),e.postProcessingEffects.push({type:this.type,uniforms:this.getUniforms(i)}))}getUniforms(t){return this.uniforms}}class h extends a{constructor(t={}){super({...t,type:"blur",fragUrl:"src/shaders/blur.frag"}),this.radius=t.radius||5}apply(t,e,i){if(i>=this.start&&i<this.start+this.duration){e.loadShader(this.type,this.fragUrl);const t=Math.max(e.width,e.height);e.postProcessingEffects.push({type:this.type,uniforms:{u_radius:this.radius,u_direction:[1,0],u_resolution:t}}),e.postProcessingEffects.push({type:this.type,uniforms:{u_radius:this.radius,u_direction:[0,1],u_resolution:t}})}}}const l={name:"BlurEffect",type:"effect",onLoad:t=>{t.registerEffectType("blur",h)}};class p{constructor({fromClip:t,toClip:e,duration:i}){if(!t||!e)throw new Error("A transition requires both a `fromClip` and a `toClip`.");if("number"!=typeof i||i<=0)throw new Error("A transition requires a positive `duration`.");this.fromClip=t,this.toClip=e,this.duration=i,this.start=this.toClip.start}getProgress(t){return t<this.start?0:t>this.start+this.duration?1:(t-this.start)/this.duration}render(t,e){throw new Error("The `render` method must be implemented by a subclass of TransitionBase.")}}class c extends p{constructor(t){super(t)}render(t,e){const i=this.getProgress(e),s=this.fromClip.properties.opacity,r=this.toClip.properties.opacity;try{this.fromClip.properties.opacity=s*(1-i),this.toClip.properties.opacity=r*i;const o=e-this.fromClip.start;for(const e of this.fromClip.effects)e.apply(this.fromClip,t,o);this.fromClip.render(t,o);const n=e-this.toClip.start;for(const e of this.toClip.effects)e.apply(this.toClip,t,n);this.toClip.render(t,n)}finally{this.fromClip.properties.opacity=s,this.toClip.properties.opacity=r}}}const d={name:"CrossFadeTransition",type:"transition",onLoad:t=>{t.registerTransitionType("crossfade",c)}};class u extends n{constructor(t={}){super(t),this.duration=t.duration||500}apply(t,e,i){if(i>=this.start&&i<this.start+this.duration){const s=(i-this.start)/this.duration;t.properties.opacity*=e.lerp(0,1,s)}}}const f={name:"FadeInEffect",type:"effect",onLoad:t=>{t.registerEffectType("fadeIn",u)}};class m extends n{constructor(t={}){super(t),this.duration=t.duration||500}apply(t,e,i){if(i>=this.start&&i<this.start+this.duration){const s=(i-this.start)/this.duration;t.properties.opacity*=e.lerp(1,0,s)}}}const g={name:"FadeOutEffect",type:"effect",onLoad:t=>{t.registerEffectType("fadeOut",m)}};class y extends n{constructor({frequency:t=1,amplitude:e=10,...i}={}){super(i),this.frequency=t,this.amplitude=e}apply(t,e){const i=t.millis()/1e3*this.frequency,s=t.noise(i),r=t.noise(i+1e4),o=(2*s-1)*this.amplitude,n=(2*r-1)*this.amplitude;e.properties.x+=o,e.properties.y+=n}}const C=[l,f,g,{name:"WiggleEffect",type:"effect",onLoad:t=>{t.registerEffectType("wiggle",y)}},d];class w{constructor(t,e,{duration:i=1e4}={}){this.duration=i,this.clips=[],this.transitions=[],this.time=0,this.isPlaying=!1,this.isBatching=!1,this.dirtyClips=new Set,this.needsClipSorting=!1,this.renderEngine=new r(t,e),this.pluginManager=new s,this.transitionTypes=new Map,this.effectTypes=new Map,this._loadBuiltInPlugins()}use(t){this.pluginManager.register(t);try{t.onLoad(this)}catch(e){o.critical(`Error loading plugin: ${t.name}`,e)}}addClip(t){this.clips.push(t),t.timeline=this,this.isBatching?this.needsClipSorting=!0:this.clips.sort((t,e)=>t.layer-e.layer)}registerTransitionType(t,e){this.transitionTypes.set(t,e)}registerEffectType(t,e){this.effectTypes.set(t,e)}addTransition(t){const e=this.transitionTypes.get(t.type);if(!e)return o.warning(`Unknown transition type: ${t.type}`),null;const i=new e(t);return this.transitions.push(i),i}batch(t){this.isBatching=!0;try{t()}finally{this.isBatching=!1,this.finalizeBatch()}}finalizeBatch(){this.dirtyClips.forEach(t=>t.finalizeChanges()),this.dirtyClips.clear(),this.needsClipSorting&&(this.clips.sort((t,e)=>t.layer-e.layer),this.needsClipSorting=!1)}getActiveClips(){const t=[];for(const e of this.clips)this.time>=e.start&&this.time<e.start+e.duration&&t.push(e);return t}_getFrameState(t){const e=new Set,i=[];for(const i of this.clips)t>=i.start&&t<i.start+i.duration&&e.add(i);for(const s of this.transitions)t>=s.start&&t<s.start+s.duration&&(i.push(s),e.add(s.fromClip),e.add(s.toClip));return{clipsToProcess:e,activeTransitions:i}}update(t){this.isPlaying&&(this.time+=t.deltaTime,this.time>=this.duration&&(this.time%=this.duration));const{clipsToProcess:e}=this._getFrameState(this.time);for(const i of e){const e=this.time-i.start;i.update(t,e)}}async render(){const{clipsToProcess:t,activeTransitions:e}=this._getFrameState(this.time);await this.renderEngine.render(t,e,this.time)}play(){this.isPlaying=!0}pause(){this.isPlaying=!1}seek(t){t>=0&&t<=this.duration&&(this.time=t)}_loadBuiltInPlugins(){for(const t of C){this.pluginManager.register(t);try{t.onLoad(this)}catch(e){o.critical(`Error loading built-in plugin: ${t.name}`,e)}}}}class x{constructor(t){if(!t||"function"!=typeof t.toDataURL)throw new Error("A valid canvas element must be provided to the FrameRecorder.");this.canvas=t,this.frames=[]}start(){this.frames=[],console.log("Frame recording started.")}captureFrame(){const t=this.canvas.toDataURL("image/webp",.8);this.frames.push(t)}stop(){console.log(`Frame recording stopped. Total frames captured: ${this.frames.length}`)}getFrames(){return this.frames}}class E{constructor({onProgress:t,onLog:e,onError:s,onComplete:r}={}){this.worker=new Worker(new URL("./encoder.worker.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:i&&"SCRIPT"===i.tagName.toUpperCase()&&i.src||new URL("p5.videoeditor.min.js",document.baseURI).href),{type:"module"}),this.onProgress=t,this.onLog=e,this.onError=s,this.onComplete=r,this.worker.onmessage=this.handleWorkerMessage.bind(this)}handleWorkerMessage({data:t}){switch(t.type){case"log":this.onLog&&this.onLog(t.data);break;case"progress":this.onProgress&&this.onProgress(t.data);break;case"error":this.onError&&this.onError(new Error(t.data));break;case"done":{const e=new Blob([t.data.buffer],{type:"video/mp4"});this.onComplete&&this.onComplete(e);break}default:console.warn("Exporter received unknown message type from worker:",t.type)}}export(t,e=30,i=null){if(!t||0===t.length){const t=new Error("Cannot export without frames.");if(!this.onError)throw t;return void this.onError(t)}this.onLog&&this.onLog("Sending frames and audio data to export worker..."),this.worker.postMessage({frames:t,frameRate:e,audioBlob:i})}terminate(){this.worker.terminate()}}class k{constructor(t,e,i){this.timeline=t,this.canvas=e,this.container=i,this.frameRecorder=new x(this.canvas),this.exporter=new E({onProgress:this.handleExportProgress.bind(this),onComplete:this.handleExportComplete.bind(this),onError:this.handleExportError.bind(this),onLog:t=>console.log("Exporter Log:",t)}),this._createUI()}_createUI(){if(!this.container)return;const t=document.createElement("div");t.style.padding="10px",t.style.backgroundColor="#f0f0f0",t.style.borderTop="1.5px solid #ccc",this.playButton=document.createElement("button"),this.playButton.textContent="Play",this.playButton.onclick=()=>{this.timeline.isPlaying?(this.pause(),this.playButton.textContent="Play"):(this.play(),this.playButton.textContent="Pause")},t.appendChild(this.playButton),this.exportButton=document.createElement("button"),this.exportButton.textContent="Ekspor Video",this.exportButton.style.marginLeft="10px",this.exportButton.onclick=()=>this.startExportProcess(),t.appendChild(this.exportButton),this.exportStatus=document.createElement("span"),this.exportStatus.style.marginLeft="15px",this.exportStatus.style.fontFamily="monospace",this.exportStatus.style.display="none",t.appendChild(this.exportStatus),this.container.appendChild(t)}async startExportProcess(){this.exportButton.disabled=!0,this.playButton.disabled=!0,this.exportStatus.style.display="inline",this.exportStatus.textContent="Rendering frames...",this.pause(),this.seek(0),this.frameRecorder.start();const t=this.timeline.frameRate||30,e=1e3/t,i=this.timeline.duration;await new Promise(t=>setTimeout(t,50));for(let t=0;t<=i;t+=e)this.timeline.seek(t),this.timeline.render(),this.frameRecorder.captureFrame();this.frameRecorder.stop(),this.exportStatus.textContent="Mengenkode video... (ini mungkin perlu waktu)",this.exporter.export(this.frameRecorder.getFrames(),t)}handleExportProgress(t){this.exportStatus.textContent=`Mengenkode... ${t}%`}handleExportComplete(t){this.exportStatus.textContent="Ekspor selesai! Memulai pengunduhan...";const e=URL.createObjectURL(t),i=document.createElement("a");i.style.display="none",i.href=e,i.download="p5-video-export.mp4",document.body.appendChild(i),i.click(),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(e),this._resetUIState()},100)}handleExportError(t){console.error("Export failed:",t),this.exportStatus.textContent=`Error: ${t.message}`,setTimeout(()=>this._resetUIState(),5e3)}_resetUIState(){this.exportButton.disabled=!1,this.playButton.disabled=!1,this.exportStatus.style.display="none",this.exportStatus.textContent=""}play(){this.timeline.play()}pause(){this.timeline.pause()}seek(t){this.timeline.seek(t)}}class b{constructor({frameRateThreshold:t=45}={}){this.frameRateThreshold=t,this.enabled=!0}monitor(t){if(!this.enabled||!t)return;const e=t.frameRate();e<this.frameRateThreshold&&console.warn(`PerformanceWarning: Frame rate is ${e.toFixed(2)} FPS, which is below the threshold of ${this.frameRateThreshold} FPS.`)}enable(){this.enabled=!0}disable(){this.enabled=!1}}class v{constructor(){this.cache=new Map,this.enabled=!0}addAsset(t,e){this.enabled&&(this.cache.set(t,e),console.log(`Asset added to cache: ${t}`))}getAsset(t){return this.cache.get(t)}clearUnusedAssets(t){if(!this.enabled)return;const e=new Set(t);let i=0;for(const t of this.cache.keys())e.has(t)||(this.cache.delete(t),i++);i>0&&console.log(`Cleared ${i} unused assets from cache.`)}clearAll(){this.cache.clear(),console.log("Cleared all assets from cache.")}enable(){this.enabled=!0}disable(){this.enabled=!1}}class P{constructor(t,e,i="linear"){this.time=t,this.value=e,this.easing=i}}const S={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t),easeInOutQuad:t=>t<.5?2*t*t:(4-2*t)*t-1,easeInCubic:t=>t*t*t,easeOutCubic:t=>--t*t*t+1,easeInOutCubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1};function T(t,e,i){const s=e.split("."),r=s.pop();s.reduce((t,e)=>(t[e]||(t[e]={}),t[e]),t)[r]=i}class _{constructor({start:t=0,duration:e=1e3,layer:i=0,assetKey:s=null,...r}={}){this.start=t,this.duration=e,this.layer=i,this.assetKey=s,this.timeline=null,this.properties={x:0,y:0,rotation:0,scale:1,opacity:1,...r.properties||{}},this.initialProperties=JSON.parse(JSON.stringify(this.properties)),this.keyframes={},this.effects=[]}addKeyframe(t,e,i,s="linear"){return this.keyframes[t]||(this.keyframes[t]=[]),this.keyframes[t].push(new P(e,i,s)),this.timeline&&this.timeline.isBatching?this.timeline.dirtyClips.add(this):this.keyframes[t].sort((t,e)=>t.time-e.time),this}addEffect(t={}){const{type:e}=t;if(!this.timeline)return o.critical("Cannot add an effect to a clip that is not on a timeline."),this;const i=this.timeline.effectTypes.get(e);if(i){const e=new i(t);this.effects.push(e)}else o.warn(`Effect with type "${e}" not found.`);return this}finalizeChanges(){for(const t in this.keyframes)Object.prototype.hasOwnProperty.call(this.keyframes,t)&&this.keyframes[t].sort((t,e)=>t.time-e.time)}update(t,e){this.properties=JSON.parse(JSON.stringify(this.initialProperties));for(const i in this.keyframes)if(Object.prototype.hasOwnProperty.call(this.keyframes,i)){const s=this._calculateValue(t,i,e);T(this.properties,i,s)}}_calculateValue(t,e,i){const s=this.keyframes[e];if(!s||0===s.length)return r=this.initialProperties,e.split(".").reduce((t,e)=>t&&t[e],r);var r;if(i<=s[0].time)return s[0].value;if(i>=s[s.length-1].time)return s[s.length-1].value;let o=0,n=s.length-1,a=0;for(;o<=n;){const t=Math.floor((o+n)/2);if(s[t].time<i)a=t,o=t+1;else{if(!(s[t].time>i))return s[t].value;n=t-1}}const h=s[a],l=s[a+1],p=(i-h.time)/(l.time-h.time),c=(S[h.easing]||S.linear)(p),d=h.value,u=l.value;return t.Color&&d instanceof t.Color&&u instanceof t.Color?t.lerpColor(d,u,c):t.lerp(d,u,c)}render(t){t.push(),t.translate(this.properties.x,this.properties.y),t.rotate(this.properties.rotation),t.scale(this.properties.scale)}}class R extends _{constructor(t,e={}){super(e),this.text=t,this.properties.fontSize=e.fontSize||24,this.properties.fill=e.fill||"#ffffff",this.properties.align=e.align||"center"}render(t,e){super.render(t,e),t.fill(this.properties.fill),t.textSize(this.properties.fontSize),t.textAlign(this.properties.align,t.CENTER),t.text(this.text,0,0),t.pop()}}class U extends _{constructor(t="rect",e={}){super({...e,properties:{width:100,height:100,fill:"#ffffff",stroke:"#000000",strokeWeight:1,...e.properties||{}}}),this.shapeType=t}render(t,e){super.render(t,e),t.fill(this.properties.fill),t.stroke(this.properties.stroke),t.strokeWeight(this.properties.strokeWeight),"rect"===this.shapeType?(t.rectMode(t.CENTER),t.rect(0,0,this.properties.width,this.properties.height)):"ellipse"===this.shapeType&&(t.ellipseMode(t.CENTER),t.ellipse(0,0,this.properties.width,this.properties.height)),t.pop()}}class L extends _{constructor(t,e={}){"string"!=typeof t||e.assetKey||(e.assetKey=t),super({...e,properties:{width:t?t.width:0,height:t?t.height:0,...e.properties||{}}}),this.image=t}render(t,e){super.render(t,e),this.image&&(t.imageMode(t.CENTER),t.image(this.image,0,0,this.properties.width,this.properties.height)),t.pop()}}class F extends _{constructor(t,e={}){"string"!=typeof t||e.assetKey||(e.assetKey=t);super({...e,properties:{volume:1,pan:0,...e.properties||{}}}),this.soundFile=t,this._isPlaying=!1}update(t,e){if(super.update(t,e),!this.soundFile||"function"!=typeof this.soundFile.play)return;this.soundFile.setVolume(this.properties.volume),this.soundFile.pan(this.properties.pan);const i=e>=0&&e<this.duration;if(i&&!this._isPlaying){const t=e/1e3;t<this.soundFile.duration()&&(this.soundFile.play(),this.soundFile.jump(t),this._isPlaying=!0)}else!i&&this._isPlaying&&(this.soundFile.stop(),this._isPlaying=!1)}render(){}}const B=["http:","https:","blob:","data:"];class M{constructor(t={}){this.x=t.x||0,this.y=t.y||0,this.width=t.width||100,this.height=t.height||50,this.start=t.start||0,this.duration=t.duration||1e3,this.onClick=t.onClick||(()=>{})}isHit(t,e){const i=this.width/2,s=this.height/2;return t>=this.x-i&&t<=this.x+i&&e>=this.y-s&&e<=this.y+s}}class I extends _{constructor(t,e={}){super(e),"string"==typeof t&&t.trim().toLowerCase().startsWith("javascript:")&&o.critical("Unsafe video protocol: javascript:. Only safe protocols are allowed.");try{const e=new URL(t,document.baseURI);B.includes(e.protocol)||o.critical(`Unsafe video protocol: ${e.protocol}. Only safe protocols are allowed.`)}catch(e){o.critical(`Invalid video source URL: ${t}`,e)}this.videoSrc=t,this.isPlaying=!1,this.videoElement=null,this.properties.width=e.width||1920,this.properties.height=e.height||1080,this.hotspots=[]}_initElement(){this.videoElement||(this.videoElement=document.createElement("video"),this.videoElement.src=this.videoSrc,this.videoElement.preload="auto",this.videoElement.muted=!0,this.videoElement.playsInline=!0)}update(t,e){this._initElement(),super.update(t,e);const i=e/1e3;(Math.abs(this.videoElement.currentTime-i)>.05||this.videoElement.paused)&&(this.videoElement.currentTime=i);const s=e>=0&&e<this.duration;if(s&&!this.isPlaying){const t=this.videoElement.play();void 0!==t&&t.catch(()=>{}),this.isPlaying=!0}else!s&&this.isPlaying&&(this.videoElement.pause(),this.isPlaying=!1)}addHotspot(t={}){return this.hotspots.push(new M(t)),this}checkClick(t,e,i,s){const r=e-this.properties.x,o=i-this.properties.y;for(const t of this.hotspots){if(s>=t.start&&s<t.start+t.duration&&t.isHit(r,o))return t.onClick(),!0}return!1}render(t,e){if(this._initElement(),super.render(t,e),this.videoElement&&this.videoElement.readyState>=3&&(t.imageMode(t.CENTER),t.image(this.videoElement,0,0,this.properties.width,this.properties.height)),t.rectMode){t.push(),t.rectMode(t.CENTER),t.stroke("rgba(255, 0, 0, 0.75)"),t.strokeWeight(2),t.noFill();for(const i of this.hotspots){e>=i.start&&e<i.start+i.duration&&t.rect(i.x,i.y,i.width,i.height)}t.pop()}t.pop()}}class A extends _{constructor(t={}){super(t),this.slides=[],this.currentSlideIndex=0,this.slideActivationTime=0}addSlide(t=[]){return this.slides.push(t),this.timeline&&t.forEach(t=>{t.timeline=this.timeline}),this}_activateSlide(t){this.currentSlideIndex=t,this.timeline&&(this.slideActivationTime=this.timeline.time-this.start)}next(){this.currentSlideIndex<this.slides.length-1&&this._activateSlide(this.currentSlideIndex+1)}previous(){this.currentSlideIndex>0&&this._activateSlide(this.currentSlideIndex-1)}update(t,e){super.update(t,e);const i=this.slides[this.currentSlideIndex];if(i){const s=e-this.slideActivationTime;i.forEach(e=>{e.update(t,s)})}}render(t){super.render(t);const e=this.slides[this.currentSlideIndex];if(e){[...e].sort((t,e)=>t.layer-e.layer).forEach(e=>{e.render(t),t.pop()})}}}class D{constructor(t,e){this.editor=t,this.timeline=t.timeline,this.container=e,this.isDragging=!1,this.draggedClip=null,this.dragStartX=0,this.originalClipStart=0,this.view={width:this.container.clientWidth,height:200,scale:50},this.colors={background:"#282828",ruler:"#333333",text:"#DDDDDD",clip:"#4A90E2",playhead:"#FF0000"},this.layout={rulerHeight:30,trackHeight:25,trackGap:5},this._createDOMElements(),this._attachEventListeners()}_createDOMElements(){this.uiContainer=document.createElement("div"),this.uiContainer.className="p5ve-timeline-ui",this.container.appendChild(this.uiContainer);new p5(t=>{this.p=t,t.setup=()=>{t.createCanvas(this.view.width,this.view.height).parent(this.uiContainer)},t.draw=()=>{this._drawTimeline()}})}_attachEventListeners(){const{p:t,layout:e}=this;t.mousePressed=()=>{if(t.mouseY<e.rulerHeight)return this.isDragging="seek",void this._handleSeek(t.mouseX);if(t.mouseY<e.rulerHeight)return this.isDragging="seek",void this._handleSeek(t.mouseX);const{clip:i,handle:s}=this._getClipHandleAt(t.mouseX,t.mouseY);i&&(this.isDragging=s,this.draggedClip=i,this.dragStartX=t.mouseX,this.originalClipStart=i.start,this.originalClipDuration=i.duration)},t.mouseDragged=()=>{if("seek"===this.isDragging)this._handleSeek(t.mouseX);else if(this.draggedClip){const e=t.mouseX-this.dragStartX,i=this._pxToTime(e);"clip"===this.isDragging?this._handleClipDrag(i):"left"===this.isDragging?this._handleResizeLeft(i):"right"===this.isDragging&&this._handleResizeRight(i)}},t.mouseReleased=()=>{this.isDragging=!1,this.draggedClip=null}}_handleSeek(t){const e=this._pxToTime(t);this.timeline.seek(e)}_handleClipDrag(t){const e=this.originalClipStart+t;this.draggedClip.start=Math.max(0,e)}_handleResizeLeft(t){const e=this.originalClipStart+t,i=this.originalClipDuration-t;i>100&&(this.draggedClip.start=Math.max(0,e),this.draggedClip.duration=i)}_handleResizeRight(t){const e=this.originalClipDuration+t;e>100&&(this.draggedClip.duration=e)}_getClipHandleAt(t,e){const{timeline:i,layout:s}=this;for(const r of i.clips){const i=this._timeToPx(r.start),o=s.rulerHeight+s.trackGap+r.layer*(s.trackHeight+s.trackGap),n=this._timeToPx(r.duration),a=s.trackHeight;if(e>=o&&e<=o+a){if(t>=i&&t<i+8)return{clip:r,handle:"left"};if(t>i+n-8&&t<=i+n)return{clip:r,handle:"right"};if(t>=i&&t<=i+n)return{clip:r,handle:"clip"}}}return{clip:null,handle:null}}_timeToPx(t){return t/1e3*this.view.scale}_pxToTime(t){return t/this.view.scale*1e3}_drawTimeline(){this.p.background(this.colors.background),this._drawRuler(),this._drawClips(),this._drawPlayhead()}_drawRuler(){const{p:t,view:e,layout:i,colors:s}=this;t.fill(s.ruler),t.noStroke(),t.rect(0,0,e.width,i.rulerHeight),t.fill(s.text),t.textAlign(t.CENTER,t.CENTER),t.textSize(10);const r=Math.floor(this._pxToTime(e.width)/1e3/1);for(let e=0;e<=r;e++){const r=1*e,o=this._timeToPx(1e3*r);t.stroke(s.text),t.line(o,i.rulerHeight-10,o,i.rulerHeight),t.noStroke(),t.text(`${r}s`,o,i.rulerHeight/2)}}_drawClips(){const{p:t,timeline:e,layout:i,colors:s}=this;t.noStroke();for(const r of e.clips){const e=this._timeToPx(r.start),o=this._timeToPx(r.duration),n=i.rulerHeight+i.trackGap+r.layer*(i.trackHeight+i.trackGap);t.fill(s.clip),t.rect(e,n,o,i.trackHeight,4),t.fill(s.text),t.textAlign(t.LEFT,t.CENTER),t.text(r.name||"Clip",e+5,n+i.trackHeight/2)}}_drawPlayhead(){const{p:t,timeline:e,view:i,colors:s,layout:r}=this,o=this._timeToPx(e.time);o>=0&&o<i.width&&(t.stroke(s.playhead),t.strokeWeight(2),t.line(o,r.rulerHeight,o,i.height))}draw(){}}t.AudioClip=F,t.ClipBase=_,t.EffectBase=n,t.ErrorHandler=o,t.ImageClip=L,t.MemoryManager=v,t.PerformanceManager=b,t.PlaybackController=k,t.ShapeClip=U,t.SlideShowClip=A,t.TextClip=R,t.Timeline=w,t.VideoClip=I,t.VideoEditor=class{static ErrorHandler=o;constructor(t,{canvas:e=null,uiContainer:i=null,timelineUiContainer:s=null,gifWorkerPath:r="./gif.worker.js",...o}={}){if(!t)throw new Error("A p5.js instance must be provided to the VideoEditor constructor.");this.options={gifWorkerPath:r},this.timeline=new w(t,e,o),this.playbackController=new k(this.timeline,e,i),this.performanceManager=new b(o.performance),this.memoryManager=new v,this.play=this.playbackController.play.bind(this.playbackController),this.pause=this.playbackController.pause.bind(this.playbackController),this.seek=this.playbackController.seek.bind(this.playbackController),s&&(this.ui=new D(this,s))}use(t){this.timeline.use(t)}async exportGIF({frameRate:t=15,quality:i=10,filename:s="p5.videoeditor-export.gif",onProgress:r=null}={}){console.log("Starting GIF export...");const o=this.playbackController.isPlaying,n=this.timeline.time;this.pause(),this.seek(0);const a=new e({workers:2,quality:i,workerScript:this.options.gifWorkerPath}),h=1e3/t,l=Math.floor(this.timeline.duration/h);for(let t=0;t<l;t++){const e=t*h;this.seek(e),this.update(this.timeline.p),await this.render(),a.addFrame(this.timeline.canvas,{copy:!0,delay:h}),r&&r((t+1)/l)}a.on("finished",t=>{const e=URL.createObjectURL(t),i=document.createElement("a");i.href=e,i.download=s,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(e),console.log("GIF export finished."),this.seek(n),o&&this.play()}),console.log("Rendering GIF frames..."),a.render()}async exportMP4({frameRate:t=30,filename:e="p5.videoeditor-export.mp4",onProgress:i=null,onLog:s=null}={}){console.log("Starting MP4 export...");const r=this.playbackController.isPlaying,n=this.timeline.time;let a=null;try{this.pause(),this.seek(0);const r=[],o=1e3/t,n=Math.floor(this.timeline.duration/o);s&&s("Generating frames...");for(let t=0;t<n;t++){const e=t*o;this.seek(e),this.update(this.timeline.p),await this.render();const s=this.timeline.canvas.toDataURL("image/webp",.9);r.push(s),i&&i((t+1)/n*10)}s&&s("Frames generated. Initializing exporter..."),await new Promise((o,n)=>{a=new E({onProgress:i,onLog:s,onError:n,onComplete:t=>{const i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log("MP4 export finished."),o()}}),a.export(r,t)})}catch(t){console.error("MP4 export failed:",t),o.showUserFriendlyError(t)}finally{a&&a.terminate(),this.seek(n),r&&this.play()}}createVideoClip(t,e={}){const i=new I(t,e);return this.timeline.addClip(i),i}createSlideShowClip(t={}){const e=new A(t);return this.timeline.addClip(e),e}createTextClip(t,e={}){const i=new R(t,e);return this.timeline.addClip(i),i}createShapeClip(t,e={}){const i=new U(t,e);return this.timeline.addClip(i),i}createImageClip(t,e={}){const i=new L(t,e);return this.timeline.addClip(i),i}createAudioClip(t,e={}){const i=new F(t,e);return this.timeline.addClip(i),i}cacheAsset(t,e){this.memoryManager.addAsset(t,e)}update(t){this.performanceManager.monitor(t),this.timeline.update(t);const e=this.timeline.getActiveClips().map(t=>t.assetKey).filter(t=>t);this.memoryManager.clearUnusedAssets(e)}async render(){await this.timeline.render()}handleMousePressed(t){const e=this.timeline.getActiveClips();for(let i=e.length-1;i>=0;i--){const s=e[i];if(s instanceof I){const e=this.timeline.time-s.start;if(s.checkClick(t,t.mouseX,t.mouseY,e))break}}}showUserFriendlyError(t){o.showUserFriendlyError(t)}}});
//# sourceMappingURL=p5.videoeditor.min.js.map
