!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("gif.js/src/GIF")):"function"==typeof define&&define.amd?define(["exports","gif.js/src/GIF"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).p5=e.p5||{},e.p5.VideoEditor={}),e.GIF)}(this,function(e,t){"use strict";var s="undefined"!=typeof document?document.currentScript:null;class i{constructor(){this.plugins=[]}register(e){e?"string"==typeof e.name&&""!==e.name.trim()?"string"==typeof e.type&&""!==e.type.trim()?"function"==typeof e.onLoad?this.plugins.some(t=>t.name===e.name)?console.warn(`Plugin with name "${e.name}" is already registered.`):this.plugins.push(e):console.warn('Invalid plugin: "onLoad" must be a function.',e):console.warn('Invalid plugin: "type" must be a non-empty string.',e):console.warn('Invalid plugin: "name" must be a non-empty string.',e):console.warn("Invalid plugin: Plugin object is null or undefined.")}}class r{constructor(e,t){this.p=e,this.canvas=t,this.width=t.width,this.height=t.height,this.sceneBuffer=e.createGraphics(this.width,this.height,e.WEBGL),this.effectBuffer=e.createGraphics(this.width,this.height,e.WEBGL),this.shaders={},this.shaderPromises={},this.postProcessingEffects=[]}loadShader(e,t){if(this.shaders[e]||this.shaderPromises[e])return;const s=this.p.loadShader("src/shaders/passthrough.vert",t,t=>{this.shaders[e]=t,delete this.shaderPromises[e],console.log(`Shader "${e}" loaded.`)});this.shaderPromises[e]=s}async render(e,t,s){this._renderScene(e,t,s);const i=await this._applyPostProcessing();this.p.image(i,0,0),this.postProcessingEffects=[]}_renderScene(e,t,s){this.sceneBuffer.clear(),this.sceneBuffer.push();const i=new Set;for(const e of t)i.add(e.fromClip),i.add(e.toClip);const r=[...e].filter(e=>!i.has(e));r.sort((e,t)=>e.layer-t.layer);for(const e of r){const t=s-e.start;for(const s of e.effects)s.apply(e,this.sceneBuffer,t);e.render(this.sceneBuffer)}for(const e of t)e.render(this.sceneBuffer,s);this.sceneBuffer.pop()}async _applyPostProcessing(){if(0===this.postProcessingEffects.length)return this.sceneBuffer;let e=this.sceneBuffer,t=this.effectBuffer;for(let s=0;s<this.postProcessingEffects.length;s++){const i=this.postProcessingEffects[s];this.shaderPromises[i.type]&&await this.shaderPromises[i.type];const r=this.shaders[i.type];if(r){if(t.shader(r),r.setUniform("u_texture",e),i.uniforms)for(const[e,t]of Object.entries(i.uniforms))r.setUniform(e,t);t.rect(-this.width/2,-this.height/2,this.width,this.height),[e,t]=[t,e]}}return e}}class o{static critical(e,t){throw console.error(`[p5.videoeditor.js] Critical Error: ${e}`),t&&console.error("Original Error:",t),new Error(`[p5.videoeditor.js] ${e}`)}static warning(e){console.warn(`[p5.videoeditor.js] Warning: ${e}`)}static showUserFriendlyError(e){console.error(`[p5.videoeditor.js] An error occurred: ${e.message}`)}}class n{constructor(e,t,{duration:s=1e4}={}){this.duration=s,this.clips=[],this.transitions=[],this.time=0,this.isPlaying=!1,this.isBatching=!1,this.dirtyClips=new Set,this.needsClipSorting=!1,this.renderEngine=new r(e,t),this.pluginManager=new i,this.transitionTypes=new Map,this.effectTypes=new Map,this._pluginsLoaded=!1}use(e){this.pluginManager.register(e)}addClip(e){this.clips.push(e),e.timeline=this,this.isBatching?this.needsClipSorting=!0:this.clips.sort((e,t)=>e.layer-t.layer)}registerTransitionType(e,t){this.transitionTypes.set(e,t)}registerEffectType(e,t){this.effectTypes.set(e,t)}addTransition(e){const t=this.transitionTypes.get(e.type);if(!t)return o.warning(`Unknown transition type: ${e.type}`),null;const s=new t(e);return this.transitions.push(s),s}batch(e){this.isBatching=!0;try{e()}finally{this.isBatching=!1,this.finalizeBatch()}}finalizeBatch(){this.dirtyClips.forEach(e=>e.finalizeChanges()),this.dirtyClips.clear(),this.needsClipSorting&&(this.clips.sort((e,t)=>e.layer-t.layer),this.needsClipSorting=!1)}getActiveClips(){const e=[];for(const t of this.clips)this.time>=t.start&&this.time<t.start+t.duration&&e.push(t);return e}_getFrameState(e){const t=new Set,s=[];for(const s of this.clips)e>=s.start&&e<s.start+s.duration&&t.add(s);for(const i of this.transitions)e>=i.start&&e<i.start+i.duration&&(s.push(i),t.add(i.fromClip),t.add(i.toClip));return{clipsToProcess:t,activeTransitions:s}}update(e){this._pluginsLoaded||(this._loadPlugins(),this._pluginsLoaded=!0),this.isPlaying&&(this.time+=e.deltaTime,this.time>=this.duration&&(this.time%=this.duration));const{clipsToProcess:t}=this._getFrameState(this.time);for(const s of t){const t=this.time-s.start;s.update(e,t)}}async render(){const{clipsToProcess:e,activeTransitions:t}=this._getFrameState(this.time);await this.renderEngine.render(e,t,this.time)}play(){this.isPlaying=!0}pause(){this.isPlaying=!1}seek(e){e>=0&&e<=this.duration&&(this.time=e)}_loadPlugins(){for(const e of this.pluginManager.plugins)try{e.onLoad(this)}catch(t){o.critical(`Error loading plugin: ${e.name}`,t)}}}class a{constructor(e){if(!e||"function"!=typeof e.toDataURL)throw new Error("A valid canvas element must be provided to the FrameRecorder.");this.canvas=e,this.frames=[]}start(){this.frames=[],console.log("Frame recording started.")}captureFrame(){const e=this.canvas.toDataURL("image/webp",.8);this.frames.push(e)}stop(){console.log(`Frame recording stopped. Total frames captured: ${this.frames.length}`)}getFrames(){return this.frames}}class h{constructor({onProgress:e,onLog:t,onError:i,onComplete:r}={}){this.worker=new Worker(new URL("./encoder.worker.js","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:s&&"SCRIPT"===s.tagName.toUpperCase()&&s.src||new URL("p5.videoeditor.min.js",document.baseURI).href),{type:"module"}),this.onProgress=e,this.onLog=t,this.onError=i,this.onComplete=r,this.worker.onmessage=this.handleWorkerMessage.bind(this)}handleWorkerMessage({data:e}){switch(e.type){case"log":this.onLog&&this.onLog(e.data);break;case"progress":this.onProgress&&this.onProgress(e.data);break;case"error":this.onError&&this.onError(new Error(e.data));break;case"done":{const t=new Blob([e.data.buffer],{type:"video/mp4"});this.onComplete&&this.onComplete(t);break}default:console.warn("Exporter received unknown message type from worker:",e.type)}}export(e,t=30){if(!e||0===e.length){const e=new Error("Cannot export without frames.");if(!this.onError)throw e;return void this.onError(e)}this.onLog&&this.onLog("Sending frames to export worker..."),this.worker.postMessage({frames:e,frameRate:t})}terminate(){this.worker.terminate()}}class l{constructor(e,t,s){this.timeline=e,this.canvas=t,this.container=s,this.frameRecorder=new a(this.canvas),this.exporter=new h({onProgress:this.handleExportProgress.bind(this),onComplete:this.handleExportComplete.bind(this),onError:this.handleExportError.bind(this),onLog:e=>console.log("Exporter Log:",e)}),this._createUI()}_createUI(){if(!this.container)return;const e=document.createElement("div");e.style.padding="10px",e.style.backgroundColor="#f0f0f0",e.style.borderTop="1.5px solid #ccc",this.playButton=document.createElement("button"),this.playButton.textContent="Play",this.playButton.onclick=()=>{this.timeline.isPlaying?(this.pause(),this.playButton.textContent="Play"):(this.play(),this.playButton.textContent="Pause")},e.appendChild(this.playButton),this.exportButton=document.createElement("button"),this.exportButton.textContent="Ekspor Video",this.exportButton.style.marginLeft="10px",this.exportButton.onclick=()=>this.startExportProcess(),e.appendChild(this.exportButton),this.exportStatus=document.createElement("span"),this.exportStatus.style.marginLeft="15px",this.exportStatus.style.fontFamily="monospace",this.exportStatus.style.display="none",e.appendChild(this.exportStatus),this.container.appendChild(e)}async startExportProcess(){this.exportButton.disabled=!0,this.playButton.disabled=!0,this.exportStatus.style.display="inline",this.exportStatus.textContent="Rendering frames...",this.pause(),this.seek(0),this.frameRecorder.start();const e=this.timeline.frameRate||30,t=1e3/e,s=this.timeline.duration;await new Promise(e=>setTimeout(e,50));for(let e=0;e<=s;e+=t)this.timeline.seek(e),this.timeline.render(),this.frameRecorder.captureFrame();this.frameRecorder.stop(),this.exportStatus.textContent="Mengenkode video... (ini mungkin perlu waktu)",this.exporter.export(this.frameRecorder.getFrames(),e)}handleExportProgress(e){this.exportStatus.textContent=`Mengenkode... ${e}%`}handleExportComplete(e){this.exportStatus.textContent="Ekspor selesai! Memulai pengunduhan...";const t=URL.createObjectURL(e),s=document.createElement("a");s.style.display="none",s.href=t,s.download="p5-video-export.mp4",document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),URL.revokeObjectURL(t),this._resetUIState()},100)}handleExportError(e){console.error("Export failed:",e),this.exportStatus.textContent=`Error: ${e.message}`,setTimeout(()=>this._resetUIState(),5e3)}_resetUIState(){this.exportButton.disabled=!1,this.playButton.disabled=!1,this.exportStatus.style.display="none",this.exportStatus.textContent=""}play(){this.timeline.play()}pause(){this.timeline.pause()}seek(e){this.timeline.seek(e)}}class c{constructor({frameRateThreshold:e=45}={}){this.frameRateThreshold=e,this.enabled=!0}monitor(e){if(!this.enabled||!e)return;const t=e.frameRate();t<this.frameRateThreshold&&console.warn(`PerformanceWarning: Frame rate is ${t.toFixed(2)} FPS, which is below the threshold of ${this.frameRateThreshold} FPS.`)}enable(){this.enabled=!0}disable(){this.enabled=!1}}class p{constructor(){this.cache=new Map,this.enabled=!0}addAsset(e,t){this.enabled&&(this.cache.set(e,t),console.log(`Asset added to cache: ${e}`))}getAsset(e){return this.cache.get(e)}clearUnusedAssets(e){if(!this.enabled)return;const t=new Set(e);let s=0;for(const e of this.cache.keys())t.has(e)||(this.cache.delete(e),s++);s>0&&console.log(`Cleared ${s} unused assets from cache.`)}clearAll(){this.cache.clear(),console.log("Cleared all assets from cache.")}enable(){this.enabled=!0}disable(){this.enabled=!1}}class d{constructor(e,t,s="linear"){this.time=e,this.value=t,this.easing=s}}const u={linear:e=>e,easeInQuad:e=>e*e,easeOutQuad:e=>e*(2-e),easeInOutQuad:e=>e<.5?2*e*e:(4-2*e)*e-1,easeInCubic:e=>e*e*e,easeOutCubic:e=>--e*e*e+1,easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1};class f{constructor({start:e=0,duration:t=1e3,layer:s=0,assetKey:i=null,...r}={}){this.start=e,this.duration=t,this.layer=s,this.assetKey=i,this.timeline=null,this.properties={x:0,y:0,rotation:0,scale:1,opacity:1,...r.properties||{}},this.initialProperties=JSON.parse(JSON.stringify(this.properties)),this.keyframes={},this.effects=[]}addKeyframe(e,t,s,i="linear"){return Object.prototype.hasOwnProperty.call(this.properties,e)||o.critical(`Property "${e}" is not a recognized or animatable property of this clip.`),this.keyframes[e]||(this.keyframes[e]=[]),this.keyframes[e].push(new d(t,s,i)),this.timeline&&this.timeline.isBatching?this.timeline.dirtyClips.add(this):this.keyframes[e].sort((e,t)=>e.time-t.time),this}addEffect(e={}){const{type:t}=e;if(!this.timeline)return o.critical("Cannot add an effect to a clip that is not on a timeline."),this;const s=this.timeline.effectTypes.get(t);if(s){const t=new s(e);this.effects.push(t)}else o.warn(`Effect with type "${t}" not found.`);return this}finalizeChanges(){for(const e in this.keyframes)Object.prototype.hasOwnProperty.call(this.keyframes,e)&&this.keyframes[e].sort((e,t)=>e.time-t.time)}update(e,t){Object.assign(this.properties,this.initialProperties);for(const s in this.keyframes)Object.prototype.hasOwnProperty.call(this.keyframes,s)&&(this.properties[s]=this._calculateValue(e,s,t))}_calculateValue(e,t,s){const i=this.keyframes[t];if(!i||0===i.length)return this.initialProperties[t];if(s<=i[0].time)return i[0].value;if(s>=i[i.length-1].time)return i[i.length-1].value;let r=0,o=i.length-1,n=0;for(;r<=o;){const e=Math.floor((r+o)/2);if(i[e].time<s)n=e,r=e+1;else{if(!(i[e].time>s))return i[e].value;o=e-1}}const a=i[n],h=i[n+1],l=(s-a.time)/(h.time-a.time),c=(u[a.easing]||u.linear)(l),p=a.value,d=h.value;return e.Color&&p instanceof e.Color&&d instanceof e.Color?e.lerpColor(p,d,c):e.lerp(p,d,c)}render(e){e.push(),e.translate(this.properties.x,this.properties.y),e.rotate(this.properties.rotation),e.scale(this.properties.scale)}}class m extends f{constructor(e,t={}){super(t),this.text=e,this.properties.fontSize=t.fontSize||24,this.properties.fill=t.fill||"#ffffff",this.properties.align=t.align||"center"}render(e,t){super.render(e,t),e.fill(this.properties.fill),e.textSize(this.properties.fontSize),e.textAlign(this.properties.align,e.CENTER),e.text(this.text,0,0),e.pop()}}class g extends f{constructor(e="rect",t={}){super({...t,properties:{width:100,height:100,fill:"#ffffff",stroke:"#000000",strokeWeight:1,...t.properties||{}}}),this.shapeType=e}render(e,t){super.render(e,t),e.fill(this.properties.fill),e.stroke(this.properties.stroke),e.strokeWeight(this.properties.strokeWeight),"rect"===this.shapeType?(e.rectMode(e.CENTER),e.rect(0,0,this.properties.width,this.properties.height)):"ellipse"===this.shapeType&&(e.ellipseMode(e.CENTER),e.ellipse(0,0,this.properties.width,this.properties.height)),e.pop()}}class y extends f{constructor(e,t={}){"string"!=typeof e||t.assetKey||(t.assetKey=e),super({...t,properties:{width:e?e.width:0,height:e?e.height:0,...t.properties||{}}}),this.image=e}render(e,t){super.render(e,t),this.image&&(e.imageMode(e.CENTER),e.image(this.image,0,0,this.properties.width,this.properties.height)),e.pop()}}class w extends f{constructor(e,t={}){"string"!=typeof e||t.assetKey||(t.assetKey=e);super({...t,properties:{volume:1,pan:0,...t.properties||{}}}),this.soundFile=e,this._isPlaying=!1}update(e,t){if(super.update(e,t),!this.soundFile||"function"!=typeof this.soundFile.play)return;this.soundFile.setVolume(this.properties.volume),this.soundFile.pan(this.properties.pan);const s=t>=0&&t<this.duration;if(s&&!this._isPlaying){const e=t/1e3;e<this.soundFile.duration()&&(this.soundFile.play(),this.soundFile.jump(e),this._isPlaying=!0)}else!s&&this._isPlaying&&(this.soundFile.stop(),this._isPlaying=!1)}render(){}}const C=["http:","https:","blob:","data:"];class E{constructor(e={}){this.x=e.x||0,this.y=e.y||0,this.width=e.width||100,this.height=e.height||50,this.start=e.start||0,this.duration=e.duration||1e3,this.onClick=e.onClick||(()=>{})}isHit(e,t){const s=this.width/2,i=this.height/2;return e>=this.x-s&&e<=this.x+s&&t>=this.y-i&&t<=this.y+i}}class x extends f{constructor(e,t={}){super(t),"string"==typeof e&&e.trim().toLowerCase().startsWith("javascript:")&&o.critical("Unsafe video protocol: javascript:. Only safe protocols are allowed.");try{const t=new URL(e,document.baseURI);C.includes(t.protocol)||o.critical(`Unsafe video protocol: ${t.protocol}. Only safe protocols are allowed.`)}catch(t){o.critical(`Invalid video source URL: ${e}`,t)}this.videoSrc=e,this.isPlaying=!1,this.videoElement=null,this.properties.width=t.width||1920,this.properties.height=t.height||1080,this.hotspots=[]}_initElement(){this.videoElement||(this.videoElement=document.createElement("video"),this.videoElement.src=this.videoSrc,this.videoElement.preload="auto",this.videoElement.muted=!0,this.videoElement.playsInline=!0)}update(e,t){this._initElement(),super.update(e,t);const s=t/1e3;(Math.abs(this.videoElement.currentTime-s)>.05||this.videoElement.paused)&&(this.videoElement.currentTime=s);const i=t>=0&&t<this.duration;if(i&&!this.isPlaying){const e=this.videoElement.play();void 0!==e&&e.catch(()=>{}),this.isPlaying=!0}else!i&&this.isPlaying&&(this.videoElement.pause(),this.isPlaying=!1)}addHotspot(e={}){return this.hotspots.push(new E(e)),this}checkClick(e,t,s,i){const r=t-this.properties.x,o=s-this.properties.y;for(const e of this.hotspots){if(i>=e.start&&i<e.start+e.duration&&e.isHit(r,o))return e.onClick(),!0}return!1}render(e,t){if(this._initElement(),super.render(e,t),this.videoElement&&this.videoElement.readyState>=3&&(e.imageMode(e.CENTER),e.image(this.videoElement,0,0,this.properties.width,this.properties.height)),e.rectMode){e.push(),e.rectMode(e.CENTER),e.stroke("rgba(255, 0, 0, 0.75)"),e.strokeWeight(2),e.noFill();for(const s of this.hotspots){t>=s.start&&t<s.start+s.duration&&e.rect(s.x,s.y,s.width,s.height)}e.pop()}e.pop()}}class b extends f{constructor(e={}){super(e),this.slides=[],this.currentSlideIndex=0,this.slideActivationTime=0}addSlide(e=[]){return this.slides.push(e),this.timeline&&e.forEach(e=>{e.timeline=this.timeline}),this}_activateSlide(e){this.currentSlideIndex=e,this.timeline&&(this.slideActivationTime=this.timeline.time-this.start)}next(){this.currentSlideIndex<this.slides.length-1&&this._activateSlide(this.currentSlideIndex+1)}previous(){this.currentSlideIndex>0&&this._activateSlide(this.currentSlideIndex-1)}update(e,t){super.update(e,t);const s=this.slides[this.currentSlideIndex];if(s){const i=t-this.slideActivationTime;s.forEach(t=>{t.update(e,i)})}}render(e){super.render(e);const t=this.slides[this.currentSlideIndex];if(t){[...t].sort((e,t)=>e.layer-t.layer).forEach(t=>{t.render(e),e.pop()})}}}e.AudioClip=w,e.ClipBase=f,e.EffectBase=class{constructor({start:e=0,duration:t=1e3}={}){this.start=e,this.duration=t}apply(e,t,s){throw new Error('The "apply()" method must be implemented by a subclass.')}},e.ErrorHandler=o,e.ImageClip=y,e.MemoryManager=p,e.PerformanceManager=c,e.PlaybackController=l,e.ShapeClip=g,e.SlideShowClip=b,e.TextClip=m,e.Timeline=n,e.VideoClip=x,e.VideoEditor=class{static ErrorHandler=o;constructor(e,{canvas:t=null,uiContainer:s=null,gifWorkerPath:i="./gif.worker.js",...r}={}){if(!e)throw new Error("A p5.js instance must be provided to the VideoEditor constructor.");this.options={gifWorkerPath:i},this.timeline=new n(e,t,r),this.playbackController=new l(this.timeline,t,s),this.performanceManager=new c(r.performance),this.memoryManager=new p,this.play=this.playbackController.play.bind(this.playbackController),this.pause=this.playbackController.pause.bind(this.playbackController),this.seek=this.playbackController.seek.bind(this.playbackController)}async exportGIF({frameRate:e=15,quality:s=10,filename:i="p5.videoeditor-export.gif",onProgress:r=null}={}){console.log("Starting GIF export...");const o=this.playbackController.isPlaying,n=this.timeline.time;this.pause(),this.seek(0);const a=new t({workers:2,quality:s,workerScript:this.options.gifWorkerPath}),h=1e3/e,l=Math.floor(this.timeline.duration/h);for(let e=0;e<l;e++){const t=e*h;this.seek(t),this.update(this.timeline.p),await this.render(),a.addFrame(this.timeline.canvas,{copy:!0,delay:h}),r&&r((e+1)/l)}a.on("finished",e=>{const t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=i,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t),console.log("GIF export finished."),this.seek(n),o&&this.play()}),console.log("Rendering GIF frames..."),a.render()}createVideoClip(e,t={}){const s=new x(e,t);return this.timeline.addClip(s),s}createSlideShowClip(e={}){const t=new b(e);return this.timeline.addClip(t),t}createTextClip(e,t={}){const s=new m(e,t);return this.timeline.addClip(s),s}createShapeClip(e,t={}){const s=new g(e,t);return this.timeline.addClip(s),s}createImageClip(e,t={}){const s=new y(e,t);return this.timeline.addClip(s),s}createAudioClip(e,t={}){const s=new w(e,t);return this.timeline.addClip(s),s}cacheAsset(e,t){this.memoryManager.addAsset(e,t)}update(e){this.performanceManager.monitor(e),this.timeline.update(e);const t=this.timeline.getActiveClips().map(e=>e.assetKey).filter(e=>e);this.memoryManager.clearUnusedAssets(t)}async render(){await this.timeline.render()}handleMousePressed(e){const t=this.timeline.getActiveClips();for(let s=t.length-1;s>=0;s--){const i=t[s];if(i instanceof x){const t=this.timeline.time-i.start;if(i.checkClick(e,e.mouseX,e.mouseY,t))break}}}showUserFriendlyError(e){o.showUserFriendlyError(e)}}});
//# sourceMappingURL=p5.videoeditor.min.js.map
